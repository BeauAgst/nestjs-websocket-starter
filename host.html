<html>

<head>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"
    integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs"
    crossorigin="anonymous"></script>
</head>

<body>
  <button class="lock">toggle lock state</button>
  <button class="reset">reset game</button>
  <table class="members"></table>
  <div class="result"></div>
  <script>
          const updateMembers = (room) => {
            const rows = room.users.map((user) => `<tr><td>${user.name}</td></tr>`).join('\n')
            const content = `<tbody>${rows}</tbody>`

            document.querySelector('.members').innerHTML = content
          }

    const socket = io('http://localhost:3000/rooms');
    socket.on('connect', function () {
      console.log('Connected');

      window.user = {
        color: '#BADA55',
        id: crypto.randomUUID(),
        name: "Room host",
        socketId: socket.id
      }

      socket.emit('CREATE_ROOM', { maxUsers: 3, user: window.user }, data => {
        console.log('CREATE_ROOM', data);
        window.room = data
        updateMembers(data)
      });
    });
    socket.on('ROOM_UPDATED', function (data) {
      const parsed = JSON.parse(data)
      console.log('ROOM_UPDATED', parsed);
      window.room = parsed
      updateMembers(parsed)
    });

  socket.on('ROOM_LOCKED', function (data) {
    console.log('ROOM_LOCKED', JSON.parse(data));
  });
  socket.on('ROOM_UNLOCKED', function (data) {
    console.log('ROOM_UNLOCKED', JSON.parse(data));
  });

    socket.on('exception', function (data) {
      console.log('event', data);
    });
    socket.on('disconnect', function () {
      console.log('Disconnected');
    });

  const lockButton = document.body.querySelector(".lock")
  const resetButton = document.body.querySelector(".reset")

  lockButton.addEventListener("click", () => {
    socket.emit("TOGGLE_ROOM_LOCKED_STATE", { user: window.user, roomId: window.room.id }, data => {
      lockButton.innerText = data.isLocked ? 'Unlock' : 'Lock'
      updateMembers(data)
    })
  })

  resetButton.addEventListener("click", () => {
    socket.emit("RESTART_GAME", { user: window.user, roomId: window.room.id }, data => {
      updateMembers(data)
    })
  })
  </script>
</body>

</html>