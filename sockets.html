<html>

<head>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"
    integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs"
    crossorigin="anonymous"></script>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react,stage-3">
    const { useState, useEffect } = React;

    const socket = io('http://localhost:3000/rooms');

    const getUserData = () => {
      const data = localStorage.getItem("user")

      if (data) {
        return JSON.parse(data)
      }

      return {}
    }

    const Container = () => {
      const [inRoom, setInRoom] = useState(false)
      const [isConnected, setIsConnected] = useState(socket.connected);
      const [me, setMe] = useState({});
      const [room, setRoom] = useState({});
      const [users, setUsers] = useState([]);

      useEffect(() => {
        onConnect = () => setIsConnected(true);
        onDisconnect = () => setIsConnected(false);
        onEvent = (event) => {
          const { operation, data } = event

          console.log(operation, data)

          switch (operation) {
            case "room_members/updated":
              if (data.room) setRoom(data.room)
              if (data.members) setUsers(data.members)
              break;
            case "room/exited":
              setInRoom(false)
              setRoom({})
              setUsers([])
              alert(`You have left the room. Reason: ${data.reason}`)
              break;
          }
        }

        socket.on('connect', onConnect);
        socket.on('disconnect', onDisconnect);
        socket.on('event', onEvent);
        socket.on('exception', (e) => console.log('exception', e));

        return () => {
          socket.off('connect', onConnect);
          socket.off('disconnect', onDisconnect);
          socket.off('event', onEvent);
        };
      }, []);

      const onCreateRoom = ({ maxMembers, name, userId }) => {
        const event = "room.create"
        const room = { maxMembers: maxMembers || null }
        const user = { id: userId, name }
        const payload = { room, user }
        console.log(`[triggered:${event}]`, payload)
        socket.emit('room.create', payload, response => {
          console.log(`[response:${event}]`, response);

          const { me, members, room } = response.data

          localStorage.setItem("user", JSON.stringify(me))

          setMe(me)
          setUsers(members)
          setRoom(room)
          setInRoom(true)
        });
      }

      const onJoinRoom = ({ name, roomCode, userId }) => {
        const event = "room.join"
        const payload = { roomId: roomCode, user: { id: userId, name } }
        console.log(`[triggered:${event}]`, payload)
        socket.emit(event, payload, response => {
          console.log(`[response:${event}]`, response);

          const { me, members, room } = response.data

          localStorage.setItem("user", JSON.stringify(me))

          setMe(me)
          setRoom(room)
          setUsers(members)
          setInRoom(true)
        });
      }

      const onClickToggleLock = () => {
        socket.emit("TOGGLE_ROOM_LOCKED_STATE", { userId: me.id, roomId: room.id }, data => {
          console.log('TOGGLE_LOCK_ROOM', data)

          setRoom(data.room)
          setUsers(data.users)
        })
      }

      const onClickKick = (userId) => {
        const event = "room.kick_user"
        const payload = { roomId: room.id, userId: me.id, userIdToKick: userId }
        console.log(`[triggered:${event}]`, payload)
        socket.emit(event, payload, response => {
          console.log(`[response:${event}]`, response);

          const { members, room } = response.data

          if (room) setRoom(room)
          if (members) setUsers(members)
        });
      }

      const onLeaveRoom = () => {
        socket.emit('room.leave', { roomId: room.id, userId: me.id }, data => {
          console.log('room.leave', data)

          setRoom({})
          setUsers([])
          setInRoom(false)
        });
      }

      const onClickMakeHost = (userId) => {
        const event = "room.pass_ownership"
        const payload = { newHostId: userId, roomId: room.id, userId: me.id }

        console.log(`[triggered:${event}]`, payload)
        socket.emit(event, payload, response => {
          console.log(`[response:${event}]`, response);

          const { data } = response

          setRoom(data.room)
        });
      }


      return (<div>
        <h1>NestJS Websocket Starter</h1>
        <div>{isConnected ? "Connected" : "Disconnected"}</div>
        {inRoom ? <RoomContainer me={me} onClickKick={onClickKick} onClickLeave={onLeaveRoom} onClickMakeHost={onClickMakeHost} onClickToggleLock={onClickToggleLock} room={room} users={users} /> : <KickoffContainer onCreateRoom={onCreateRoom} onJoinRoom={onJoinRoom} />}
      </div>)
    }

    const KickoffContainer = ({ onCreateRoom, onJoinRoom }) => {
      const userData = getUserData()
      const [name, setName] = useState(userData.name ?? "")
      const [maxMembers, setMaxUsers] = useState("")
      const [roomCode, setRoomCode] = useState(localStorage.getItem("roomCode") || "")
      const isValidName = /^[a-zA-Z ]{2,}$/.test(name)
      const isValidRoomCode = /^[A-Z0-9]{4}$/.test(roomCode)
      const isValidUsers = !maxMembers || /^\d{1,2}$/.test(maxMembers)

      const handleRoomCodeChange = (event) => {
        const value = event.target.value;
        setRoomCode(value.toUpperCase());
      };

      const handleMaxUsersChange = (event) => {
        const value = event.target.value;

        if (!value) {
          setMaxUsers("")
        }

        const valueAsNumber = Number(value)

        if (value.length > 1 && (valueAsNumber > 20)) return

        setMaxUsers(valueAsNumber)
      }

      const userId = userData.id ?? undefined

      const onClickCreateRoom = () => {
        localStorage.setItem("roomCode", roomCode)
        onCreateRoom({ maxMembers, name, userId })
      }
      const onClickJoinRoom = () => {
        localStorage.setItem("roomCode", roomCode)
        onJoinRoom({ name, roomCode, userId })
      }
      const onSubmit = (e) => e.preventDefault()

      return (<form onSubmit={onSubmit}>
        <input onChange={(e) => setName(e.target.value)} maxLength={20} minLength={2} placeholder="Enter your name" value={name} />
        <input onChange={handleMaxUsersChange} pattern="^\d{1,2}$" placeholder="Maximum users" value={maxMembers} />
        <button disabled={!isValidName || !isValidUsers} onClick={onClickCreateRoom}>Create room</button>
        <input maxLength={4} minLength={4} onChange={handleRoomCodeChange} pattern="^[A-Z0-9]{4}$" placeholder="Enter a room code" value={roomCode} />
        <button disabled={!isValidName || !isValidRoomCode || !isValidUsers} onClick={onClickJoinRoom}>Join room</button>
      </form>)
    }

    const RoomMembers = ({ hostId, me, onClickKick, onClickLeave, onClickMakeHost, users }) => {
      return (<table><tbody>{users.map((user) => (<tr key={user.id}>
        <td>{user.name} ({user.status}) ({hostId === user.id ? "Host" : "Participant"})</td>
        <td><button onClick={() => onClickMakeHost(user.id)}>Make host</button></td>
        <td><button onClick={() => onClickKick(user.id)}>Kick</button></td>
        {
          user.id === me.id &&
          <>
            <td>{<button onClick={onClickLeave}>Leave</button>}</td>
          </>
        }
      </tr>)
      )}</tbody></table>)
    }

    const RoomContainer = ({ me, onClickKick, onClickLeave, onClickMakeHost, onClickToggleLock, room, users }) => {
      return <>
        <h1>Room code: {room.id}</h1>
        {room.hostId === me.id && <button onClick={onClickToggleLock}>{room.isLocked ? "Unlock" : "Lock"} room</button>}
        <RoomMembers hostId={room.hostId} me={me} onClickKick={onClickKick} onClickLeave={onClickLeave} onClickMakeHost={onClickMakeHost} onClickToggleLock={onClickToggleLock} users={users} />
      </>
    }

    ReactDOM.render(<Container />, document.getElementById("root"));
  </script>

  <!-- This is what supports JSX compilation (and other transformations) -->
  <script src="https://unpkg.com/@babel/standalone@7.10.3/babel.min.js"></script>

  <!-- These are for React -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.development.js"></script>
</body>

</html>