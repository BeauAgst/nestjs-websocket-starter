<html>

<head>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"
    integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs"
    crossorigin="anonymous"></script>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react,stage-3">
    const { useState, useEffect } = React;

    const socket = io('http://localhost:3000/rooms');

    const getUserData = () => {
      const data = localStorage.getItem("user")

      if (data) {
        return JSON.parse(data)
      }

      return {}
    }

    const Container = () => {
      const [inRoom, setInRoom] = useState(false)
      const [isConnected, setIsConnected] = useState(socket.connected);
      const [me, setMe] = useState({});
      const [room, setRoom] = useState({});
      const [users, setUsers] = useState([]);

      useEffect(() => {
        onConnect = () => setIsConnected(true);
        onDisconnect = () => setIsConnected(false);
        onEvent = (event) => {
          const parsed = JSON.parse(event)
          console.log('EVENT', parsed);

          if (parsed.kicked) {
            setInRoom(false)
            setRoom({})
            setUsers([])
          }

          if (parsed.room) setRoom(parsed.room)
          if (parsed.users) setUsers(parsed.users)
        }

        socket.on('connect', onConnect);
        socket.on('disconnect', onDisconnect);
        socket.on('event', onEvent);

        return () => {
          socket.off('connect', onConnect);
          socket.off('disconnect', onDisconnect);
          socket.off('event', onEvent);
        };
      }, []);

      const onCreateRoom = ({ maxUsers, name, userId }) => {
        socket.emit('CREATE_ROOM', { room: { maxUsers: maxUsers || undefined }, user: { id: userId, name } }, data => {
          console.log('CREATE_ROOM', data);

          localStorage.setItem("user", JSON.stringify(data.me))

          setMe(data.me)
          setRoom(data.room)
          setUsers(data.users)
          setInRoom(true)
        });
      }

      const onJoinRoom = ({ name, roomCode, userId }) => {
        socket.emit('JOIN_ROOM', { roomId: roomCode, user: { id: userId, name } }, data => {
          console.log('JOIN_ROOM', data)

          localStorage.setItem("user", JSON.stringify(data.me))

          setMe(data.me)
          setRoom(data.room)
          setUsers(data.users)
          setInRoom(true)
        });
      }

      const onClickToggleLock = () => {
        socket.emit("TOGGLE_ROOM_LOCKED_STATE", { userId: me.id, roomId: room.id }, data => {
          console.log('TOGGLE_LOCK_ROOM', data)

          setRoom(data.room)
          setUsers(data.users)
        })
      }

      const onClickKick = (userId) => {
        socket.emit('KICK_USER', { roomId: room.id, userId: me.id, userIdToKick: userId }, data => {
          console.log('KICK_USER', data)

          setRoom(data.room)
          setUsers(data.users)
        });
      }

      const onLeaveRoom = () => {
        socket.emit('LEAVE_ROOM', { roomId: room.id, userId: me.id }, data => {
          console.log('LEAVE_ROOM', data)

          setRoom({})
          setUsers([])
          setInRoom(false)
        });
      }

      const onClickMakeHost = (userId) => {
        socket.emit('PASS_ROOM_OWNERSHIP', { newHostId: userId, roomId: room.id, userId: me.id }, data => {
          console.log('PASS_ROOM_OWNERSHIP', data)

          setRoom(data.room)
          setUsers(data.users)
        });
      }


      return (<div>
        <h1>NestJS Websocket Starter</h1>
        <div>{isConnected ? "Connected" : "Disconnected"}</div>
        {inRoom ? <RoomContainer me={me} onClickKick={onClickKick} onClickLeave={onLeaveRoom} onClickMakeHost={onClickMakeHost} onClickToggleLock={onClickToggleLock} room={room} users={users} /> : <KickoffContainer onCreateRoom={onCreateRoom} onJoinRoom={onJoinRoom} />}
      </div>)
    }

    const KickoffContainer = ({ onCreateRoom, onJoinRoom }) => {
      const userData = getUserData()
      const [name, setName] = useState(userData.name ?? "")
      const [maxUsers, setMaxUsers] = useState("")
      const [roomCode, setRoomCode] = useState("")
      const isValidName = /^[a-zA-Z ]{2,}$/.test(name)
      const isValidRoomCode = /^[A-Z0-9]{4}$/.test(roomCode)
      const isValidUsers = !maxUsers || /^\d{1,2}$/.test(maxUsers)

      const handleRoomCodeChange = (event) => {
        const value = event.target.value;
        setRoomCode(value.toUpperCase());
      };

      const handleMaxUsersChange = (event) => {
        const value = event.target.value;

        if (!value) {
          setMaxUsers("")
        }

        const valueAsNumber = Number(value)

        if (value.length > 1 && (valueAsNumber > 20)) return

        setMaxUsers(valueAsNumber)
      }

      const userId = userData.id ?? undefined

      const onClickCreateRoom = () => onCreateRoom({ maxUsers, name, userId })
      const onClickJoinRoom = () => onJoinRoom({ name, roomCode, userId })
      const onSubmit = (e) => e.preventDefault()

      return (<form onSubmit={onSubmit}>
        <input onChange={(e) => setName(e.target.value)} maxLength={20} minLength={2} placeholder="Enter your name" value={name} />
        <input onChange={handleMaxUsersChange} pattern="^\d{1,2}$" placeholder="Maximum users" value={maxUsers} />
        <button disabled={!isValidName || !isValidUsers} onClick={onClickCreateRoom}>Create room</button>
        <input maxLength={4} minLength={4} onChange={handleRoomCodeChange} pattern="^[A-Z0-9]{4}$" placeholder="Enter a room code" value={roomCode} />
        <button disabled={!isValidName || !isValidRoomCode || !isValidUsers} onClick={onClickJoinRoom}>Join room</button>
      </form>)
    }

    const RoomMembers = ({ hostId, me, onClickKick, onClickLeave, onClickMakeHost, users }) => {
      const isHost = hostId === me?.id
      return (<table><tbody>{users.map((user) => (<tr key={user.id}>
        <td>{user.name} ({user.status}) ({hostId === user.id ? "Host" : "Participant"})</td>
        {isHost && hostId !== user.id && <>
          <td><button onClick={() => onClickMakeHost(user.id)}>Make host</button></td>
          <td><button onClick={() => onClickKick(user.id)}>Kick</button></td>
        </>
        }
        {
          user.id === me.id &&
          <>
            <td></td>
            <td>{<button onClick={onClickLeave}>Leave</button>}</td>
          </>
        }
      </tr>)
      )}</tbody></table>)
    }

    const RoomContainer = ({ me, onClickKick, onClickLeave, onClickMakeHost, onClickToggleLock, room, users }) => {
      return <>
        <h1>Room code: {room.id}</h1>
        {room.hostId === me.id && <button onClick={onClickToggleLock}>{room.isLocked ? "Unlock" : "Lock"} room</button>}
        <RoomMembers hostId={room.hostId} me={me} onClickKick={onClickKick} onClickLeave={onClickLeave} onClickMakeHost={onClickMakeHost} onClickToggleLock={onClickToggleLock} users={users} />
      </>
    }

    ReactDOM.render(<Container />, document.getElementById("root"));
  </script>

  <!-- This is what supports JSX compilation (and other transformations) -->
  <script src="https://unpkg.com/@babel/standalone@7.10.3/babel.min.js"></script>

  <!-- These are for React -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.development.js"></script>
</body>

</html>